<!DOCTYPE html>
<html>
<head>
  <title>Beta Signup - CollectFlo</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
  <!-- Simple Navigation -->
  <nav class="bg-white border-b border-gray-200 py-4">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <div class="text-2xl font-bold text-blue-600">CollectFlo</div>
      <div class="space-x-4">
        <a href="/" class="text-blue-600 hover:text-blue-800">Back to Home</a>
        <a href="/login" class="text-blue-600 hover:text-blue-800">Log In</a>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-16">
    <div class="max-w-md mx-auto">
      <div class="text-center mb-6">
        <span class="bg-purple-100 text-purple-800 text-sm font-semibold px-3 py-1 rounded-full">
          üöÄ BETA ACCESS
        </span>
      </div>
      <h1 class="text-3xl font-bold mb-6 text-center">Get Lifetime Free Access</h1>
      <p class="text-gray-600 mb-4 text-center">Join our exclusive beta program and get CollectFlo for free, forever!</p>
      <p class="text-green-600 mb-8 text-center font-semibold">Beta users get lifetime access at $0/month</p>

      <form onsubmit="handleBetaSignup(event)" class="space-y-6 bg-white p-8 rounded-lg shadow">
        <div>
          <label class="block text-sm font-medium mb-1">Company Name</label>
          <input type="text" id="company_name" required class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-purple-500">
          <p class="text-xs text-gray-500 mt-1">Your company or organization name</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Full Name</label>
          <input type="text" id="name" required class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-purple-500">
          <p class="text-xs text-gray-500 mt-1">Your first and last name</p>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Work Email</label>
          <input type="email" id="email" required class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-purple-500">
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Password</label>
          <input type="password" id="password" required class="w-full px-4 py-2 border rounded focus:ring-2 focus:ring-purple-500">
          <p class="text-xs text-gray-500 mt-1">Minimum 8 characters, include a number and a letter</p>
        </div>

        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
          <h3 class="text-sm font-semibold text-purple-800 mb-2">Beta Program Benefits:</h3>
          <ul class="text-sm text-purple-700 space-y-1">
            <li>‚úì Lifetime free access to CollectFlo</li>
            <li>‚úì All premium features included</li>
            <li>‚úì Priority support</li>
            <li>‚úì Influence product development</li>
          </ul>
        </div>

        <button type="submit" id="submit-button" class="w-full bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700">
          Join Beta Program
        </button>
      </form>
    </div>
  </div>

  <script>
    function showError(message) {
      // Remove any existing error messages
      const existingError = document.getElementById('error-message');
      if (existingError) {
        existingError.remove();
      }

      // Create and show error message
      const errorDiv = document.createElement('div');
      errorDiv.id = 'error-message';
      errorDiv.className = 'bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-4';
      errorDiv.innerHTML = `<strong>Error:</strong> ${message}`;

      const form = document.querySelector('form');
      form.insertBefore(errorDiv, form.firstChild);
    }

    function showSuccess(message) {
      // Remove any existing messages
      const existingError = document.getElementById('error-message');
      if (existingError) {
        existingError.remove();
      }

      // Create and show success message
      const successDiv = document.createElement('div');
      successDiv.className = 'bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded mb-4';
      successDiv.innerHTML = `<strong>Success:</strong> ${message}`;

      const form = document.querySelector('form');
      form.insertBefore(successDiv, form.firstChild);
    }

    function validateForm() {
      const company_name = document.getElementById('company_name').value.trim();
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;
      
      // Basic validation
      if (!company_name || company_name.length < 2) {
        showError('Company name must be at least 2 characters long.');
        return false;
      }
      
      if (!name || name.length < 2) {
        showError('Full name must be at least 2 characters long.');
        return false;
      }
      
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailRegex.test(email)) {
        showError('Please enter a valid email address.');
        return false;
      }
      
      if (password.length < 8) {
        showError('Password must be at least 8 characters long.');
        return false;
      }
      
      if (!/[a-zA-Z]/.test(password) || !/\d/.test(password)) {
        showError('Password must include at least one letter and one number.');
        return false;
      }
      
      return true;
    }

    async function handleBetaSignup(event) {
      event.preventDefault();
      console.log('üü°  Form submission started');

      // Validate form before submission
      if (!validateForm()) {
        console.log('üî¥  Form validation failed ‚Äì aborting submit');
        return;
      }

      // Add loading state
      const submitButton = document.getElementById('submit-button');
      const originalText = submitButton.innerHTML;
      submitButton.disabled = true;
      submitButton.innerHTML = 'Creating Account...';

      // Gather form data
      const formData = {
        company_name: document.getElementById('company_name').value.trim(),
        companyName:  document.getElementById('company_name').value.trim(), // camelCase alias for validator
        name:         document.getElementById('name').value.trim(),
        fullName:     document.getElementById('name').value.trim(),        // camelCase alias for validator
        email:        document.getElementById('email').value.trim().toLowerCase(),
        password:     document.getElementById('password').value,
        betaUser:     true
      };

      console.log('üì§  Beta signup attempt with data:', formData);

      try {
        console.log('üåê  Sending fetch request to /api/beta-signup');
        const response = await fetch('/api/beta-signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        });

        console.log('üì•  Response received ‚Äì status:', response.status);
        console.log('üì•  Response headers:', Object.fromEntries(response.headers.entries()));

        // Read raw response text first for easier debugging
        const responseText = await response.text();
        console.log('üìú  Raw response text:', responseText);

        // Attempt to parse JSON
        let data;
        try {
          data = JSON.parse(responseText);
          console.log('‚úÖ  Parsed JSON:', data);
        } catch (parseErr) {
          console.error('‚ùå  Failed to parse response JSON:', parseErr);
          showError('Invalid response from server. Please try again.');
          return;
        }

        if (response.ok) {
          console.log('üéâ  Beta signup successful');
          console.log('‚û°Ô∏è   Redirect URL (if provided):', data.redirect);
          showSuccess('Account created successfully! Redirecting...');

          const redirectUrl = data.redirect || '/beta-onboarding?from=beta-signup';
          console.log('‚è≥  Waiting 1.5 s before redirect to', redirectUrl);
          setTimeout(() => {
            console.log('üöÄ  Redirecting now‚Ä¶');
            window.location.href = redirectUrl;
          }, 1500);
        } else {
          console.error('‚ö†Ô∏è  Beta signup failed ‚Äì server responded with error:', data);
          if (data.errors && data.errors.length > 0) {
            showError(data.errors[0].msg || data.message || 'Signup failed. Please check your information.');
          } else {
            showError(data.message || 'Signup failed. Please try again.');
          }
        }
      } catch (error) {
        console.error('‚ùå  Network or fetch error:', error);
        showError('Network error occurred. Please check your connection and try again.');
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
        console.log('üîµ  Form submission finished');
      }
    }
  </script>
</body>
</html>
